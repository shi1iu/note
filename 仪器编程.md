# 仪器编程

```c
//#include <windows.h> //通过 windows 的 WINSOCK 组件程控仪器
#include <stdlib.h>
#include <stdio.h>
#include <winsock2.h>
#include <ws2tcpip.h>
#include "visa.h"
#pragma comment(lib, "ws2_32.lib")
/*------------------------------------------------------------------------------
//功能说明：使用 socket 实现网络程控，读取 4082 频谱分析仪频谱轨迹
//输入参数：无
//输出参数：无
//返回值：0 成功，1 失败
------------------------------------------------------------------------------*/
int TestSocket(void);


ViSession analyzer;
ViSession defaultRM;
const char analyzerString[VI_FIND_BUFLEN] = "GPIB0::20::INSTR";
int analyzerTimeout = 10000;

int main()
{
	int a= TestSocket();
	printf("%d",a);
}

void SimpleSettings()
{
	ViStatus status;
	long retCnt;
	//设置中心频率128MHz
	status = viWrite(analyzer, ":FREQENCY:CENTER 128MHz", 22, &retCnt);
}

void InitDevice()
{
	ViStatus status;
	long retCnt;
	status = viWrite(analyzer, "*CLS\n", 5, &retCnt); //复位状态寄存器
	status = viWrite(analyzer, "*RST\n", 5, &retCnt); //复位仪器
	status = viWrite(analyzer, ":INST:SEL SA\n", 13, &retCnt); /
}

int TestSocket(void)
{
	int iResult = 0; //返回值
	int iLength = 0; //返回的数据长度
	char str[100]; //指令或返回数据存放缓冲区
	double retVal[1001]; //仪器轨迹数据可变（101～120001），实际使用时请确保
	//申请足够的空间保存读回的轨迹数据
	char* cSendbuf = NULL; //发送命令字符串缓冲区
	WSADATA wsaData;
	SOCKET clientSocket;
	SOCKADDR_IN serverAddr;
	int iAddrLen = sizeof(SOCKADDR);
	serverAddr.sin_family = AF_INET;
	//在实际应用中 127.0.0.1 替换为 4082 实际 IP 地址 
	//serverAddr.sin_addr.s_addr = htonl("192.168.6.11");
	serverAddr.sin_addr.S_un.S_addr = inet_addr("192.168.6.11");
	serverAddr.sin_port = htons(5025); //端口号为 5025
	iResult = WSAStartup(MAKEWORD(1, 1), &wsaData);
	if (iResult != NO_ERROR)
	{
		printf("WSAStartup failed with error: %d\n", iResult);
		return 1;
	}
	clientSocket = socket(AF_INET, SOCK_STREAM, 0);
	if (clientSocket == INVALID_SOCKET)
	{
		printf("socket failed with error: %ld\n", WSAGetLastError());
		WSACleanup();
		return 1;
	}
	iResult = connect(clientSocket, (SOCKADDR*)&serverAddr, iAddrLen);
	if (iResult == SOCKET_ERROR)
	{
		printf("connect failed with error: %d\n", WSAGetLastError());
		closesocket(clientSocket);
		WSACleanup();
		return 1;
	}
	//设置仪器为频谱分析模式
	cSendbuf = (char*)":INST:SEL SA\n";
	iResult = send(clientSocket, cSendbuf, (int)strlen(cSendbuf), 0);
	//设置仪器为扫频分析测量功能
	cSendbuf = (char*)":CONF:SAN\n";
	iResult = send(clientSocket, cSendbuf, (int)strlen(cSendbuf), 0);
	//设置读取轨迹数据格式为 double 类型
	cSendbuf = (char*)":FORM:TRAC REAL,64\n";
	iResult = send(clientSocket, cSendbuf, (int)strlen(cSendbuf), 0);
	//读取轨迹 1 的轨迹数据
	cSendbuf = (char*)":TRAC? TRACE1\n";
	iResult = send(clientSocket, cSendbuf, (int)strlen(cSendbuf), 0);
	//读一个字符，正常应该接收到“#”
	iResult = recv(clientSocket, str, 1, 0);
	if (iResult < 1)
	{
		WSACleanup();
		closesocket(clientSocket);
		return 1;
	}
	str[1] = '\0';
	if (0 != strcmp(str, "#")) //判断第一个字符是否为“#”
	{
		WSACleanup();
		closesocket(clientSocket);
		return 1;
	}
	//读第二个字符，正常应该为返回数据字节量代表的数据位数
	//例如：返回 1024 字节，应该读到 4；返回 16384 字节，应该读到 5
	iResult = recv(clientSocket, str, 1, 0);
	if (iResult < 1)
	{
		WSACleanup();
		closesocket(clientSocket);
		return 1;
	}
	//读取返回数据的字节量
	iLength = atoi(str);
	iResult = recv(clientSocket, str, iLength, 0);
	if (iResult < 1)
	{
		WSACleanup();
		closesocket(clientSocket);
		return 1;
	}
	//读取返回数据
	str[iLength] = '\0';
	iLength = atoi(str);
	iResult = recv(clientSocket, (char*)retVal, iLength, 0);
	if (iResult < 1)
	{
		WSACleanup();
		closesocket(clientSocket);
		return 1;
	}
	//读入\n 结束标志
	iResult = recv(clientSocket, str, 1, 0);
	if (iResult < 1)
	{
		WSACleanup();
		closesocket(clientSocket);
		return 1;
	}
	str[1] = '\0';
	WSACleanup();
	closesocket(clientSocket);
	return 0;
}
```

### 1.要获取频谱图上的峰值、次峰值及其差值

**步骤1：设置频谱分析仪到扫频分析模式**

```scpi
:CONFigure:SANalyzer
```

**步骤2：执行单次扫描并等待完成**

```scpi
:INITiate:CONTinuous OFF  ; 设置为单次扫描
:INITiate:IMMediate       ; 启动扫描
*OPC?                     ; 等待扫描完成（返回1后继续）
```

**步骤3：定位主峰值**

```scpi
:CALCulate:MARKer1:MAXimum  ; 将标记1设为峰值
:CALCulate:MARKer1:Y?       ; 查询主峰幅度（单位：dBm）
```

**步骤4：定位次峰值**

```scpi
:CALCulate:MARKer2:MAXimum:NEXT  ; 将标记2设为下一个峰值（次峰）
:CALCulate:MARKer2:Y?            ; 查询次峰幅度（单位：dBm）
```